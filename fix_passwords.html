<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Fix Passwords</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            background: #111;
            color: #fff;
            font-family: monospace;
            padding: 20px;
        }
    </style>
</head>

<body>
    <h1>Reseting Passwords...</h1>
    <div id="logs"></div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://vbjuwbwwabctmyyzlzuu.supabase.co';
        // Need SERVICE ROLE KEY for Admin API. 
        // Trying to use provided Publishable Key with signInWithPassword first to check if we can update self? 
        // No, need to update OTHERS.

        // Wait... I don't have the Service Role Key exposed in the chat context. 
        // I created the users via SQL.
        // Hashing logic in SQL (pgcrypto) might be slightly different than GoTrue's bcrypt settings.

        // ALTERNATE STRATEGY: 
        // If I can't use Admin API, I will force a "clean" hash by creating A NEW user via the public SignUp (which worked for rate-limit check earlier but failed)
        // OR... I can try to use the SAME hash that Alpha has, but maybe the "instance_id" or "aud" I set manually in SQL was wrong?

        // Let's check the SQL data again.
        // Alpha: instance_id: 0000... aud: authenticated
        // Beta: instance_id: 0000... aud: authenticated

        // They look IDENTICAL.

        // HYPOTHESIS: Perhaps the "Copy Paste" of the hash included a newline or hidden char?
        // Query result: "$2a$06$4vj8ImGC..."

        // Let's try to generate a NEW hash using a simple library on the client side? NO, GoTrue does it.

        // PLAN B: Use the `resetPasswordForEmail` flow for EACH user.
        // This sends an email. I can't check their emails.

        // PLAN C: DELETE Beta and Re-Create him via public SignUp (if rate limit allows, or wait).
        // Since I deleted them before...

        // Let's try to SignUp 'beta@flyreferral.com' with '123456' using this script.
        // If it works, I get a NEW UUID. Then I migrate Profile/Leads to NEW UUID.

        const SUPABASE_KEY = 'sb_publishable_c8uJYXuq1clJ_LXS72ZkkA_GfLokXSI';
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const usersToFix = [
            { email: 'beta@flyreferral.com', pass: '123456' },
            { email: 'ref1@test.com', pass: '123456' },
            { email: 'ref2@test.com', pass: '123456' },
            { email: 'ref4@test.com', pass: '123456' },
            { email: 'admin@flyreferral.com', pass: '123456' }
        ];

        async function run() {
            const logs = document.getElementById('logs');
            const results = [];

            for (const u of usersToFix) {
                logs.innerHTML += `<p>Processing ${u.email}...</p>`;

                // 1. Try SignUp
                let { data, error } = await client.auth.signUp({
                    email: u.email,
                    password: u.pass
                });

                if (error) {
                    logs.innerHTML += `<p style="color:red">Error signing up ${u.email}: ${error.message}</p>`;
                } else if (data.user) {
                    // It worked!
                    if (data.user.identities && data.user.identities.length > 0) {
                        logs.innerHTML += `<p style="color:green">Success: ${u.email} -> UUID: ${data.user.id}</p>`;
                        results.push({ email: u.email, newUuid: data.user.id });
                    } else {
                        logs.innerHTML += `<p style="color:orange">Created but Identity missing? Legacy issue?: ${data.user.id}</p>`;
                    }
                }
            }

            logs.innerHTML += `<h2>Final Mapping JSON</h2>`;
            logs.innerHTML += `<textarea style="width:100%; height:200px">${JSON.stringify(results, null, 2)}</textarea>`;
        }

        run();
    </script>
</body>

</html>